<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ozobot Evo Simulator v2</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --panel-color: #ffffff;
            --text-color: #333;
            --accent-color: #007bff;
            --border-radius: 8px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            padding: 20px;
        }

        h1 { margin-bottom: 10px; color: #444; }

        .main-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* --- Canvas Area --- */
        .canvas-wrapper {
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: white;
            border: 2px solid #ddd;
        }

        canvas {
            display: block;
            cursor: crosshair;
            /* Grid background pattern */
            background-image: 
                linear-gradient(#eee 1px, transparent 1px),
                linear-gradient(90deg, #eee 1px, transparent 1px);
            background-size: 30px 30px; 
        }

        /* --- Controls Panel --- */
        .controls {
            background: var(--panel-color);
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .section-title {
            font-size: 1.1em;
            font-weight: 600;
            border-bottom: 2px solid #eee;
            padding-bottom: 8px;
            margin-bottom: 10px;
            margin-top: 0;
        }

        /* Color Palette */
        .palette {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .swatch {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: transform 0.1s, border-color 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .swatch:hover { transform: scale(1.1); }
        .swatch.selected { border-color: #333; transform: scale(1.1); }

        /* Buttons */
        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button {
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            font-size: 14px;
            transition: filter 0.2s;
            color: white;
        }
        button:hover { filter: brightness(1.1); }
        
        .btn-play { background-color: #28a745; }
        .btn-stop { background-color: #ffc107; color: #333; }
        .btn-demo { background-color: #17a2b8; }
        .btn-clear { background-color: #dc3545; }

        /* Status Display */
        .status-box {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            border: 1px solid #eee;
        }
        .status-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }
        .status-val { font-weight: bold; color: var(--accent-color); }
        
        .code-flash {
            color: #d63384; 
            animation: flash 1s infinite alternate;
        }

        /* --- Help / Reference Menu --- */
        /* Modal Overlay */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.show {
            display: flex;
        }
        
        /* Modal Content */
        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            background: #007bff;
            color: white;
            padding: 20px;
            font-weight: bold;
            font-size: 18px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }
        .modal-close:hover {
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
        }
        
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(80vh - 80px);
        }
        
        .help-menu {
            border: none;
            border-radius: 0;
            overflow: visible;
        }
        .help-header {
            display: none;
        }
        .help-content {
            padding: 0;
            max-height: none;
            overflow-y: visible;
        }
        
        /* Floating Help Button */
        .floating-help-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #007bff;
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .floating-help-btn:hover {
            background: #0056b3;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        /* Floating Settings Button */
        .floating-settings-btn {
            position: fixed;
            bottom: 20px;
            right: 75px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: #28a745;
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .floating-settings-btn:hover {
            background: #218838;
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        .help-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
        }
        .code-viz {
            display: flex;
            border: 1px solid #ccc;
        }
        .code-block {
            width: 12px;
            height: 12px;
        }

        @keyframes flash { from { opacity: 1; } to { opacity: 0.5; } }
    </style>
</head>
<body>

    <h1>ü§ñ Ozobot Evo 2D Simulator</h1>

    <div class="main-container">
        
        <div class="canvas-wrapper">
            <canvas id="simCanvas" width="600" height="600"></canvas>
        </div>

        <div class="controls">
            
            <div>
                <h3 class="section-title">üé® Draw Path</h3>
                <div class="palette">
                    <div class="swatch selected" style="background: black;" onclick="setColor('black')" title="Line (Black)"></div>
                    <div class="swatch" style="background: red;" onclick="setColor('red')" title="Code (Red)"></div>
                    <div class="swatch" style="background: green;" onclick="setColor('green')" title="Code (Green)"></div>
                    <div class="swatch" style="background: blue;" onclick="setColor('blue')" title="Code (Blue)"></div>
                    <div class="swatch" style="background: white; border: 1px solid #ccc;" onclick="setColor('white')" title="Eraser"></div>
                </div>
                <div style="margin-top: 10px;">
                    <button onclick="setColor('robot')" style="width: 100%; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">
                        ü§ñ Set Robot Position
                    </button>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        <div style="margin-bottom: 5px;">Robot Direction:</div>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px;">
                            <div></div>
                            <button onclick="setRobotDirection(0)" style="padding: 5px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 16px; color: black;">‚Üë</button>
                            <div></div>
                            <button onclick="setRobotDirection(3)" style="padding: 5px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 16px; color: black;">‚Üê</button>
                            <button onclick="setRobotDirection(2)" style="padding: 5px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 16px; color: black;">‚Üì</button>
                            <button onclick="setRobotDirection(1)" style="padding: 5px; background: #f0f0f0; border: 1px solid #ccc; border-radius: 4px; cursor: pointer; font-size: 16px; color: black;">‚Üí</button>
                        </div>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="section-title">‚öôÔ∏è Actions</h3>
                <div class="btn-group">
                    <button id="playBtn" class="btn-play" onclick="togglePlay()">‚ñ∂ Start Robot</button>
                    <button class="btn-demo" onclick="loadDemo()">üïπÔ∏è Load Demo Track</button>
                    <button class="btn-clear" onclick="clearGrid()">üóë Clear Board</button>
                </div>
            </div>

            <div>
                <h3 class="section-title">üìä Status</h3>
                <div class="status-box">
                    <div class="status-row"><span>State:</span> <span id="statusState" class="status-val">Idle</span></div>
                    <div class="status-row"><span>Direction:</span> <span id="statusDir" class="status-val">East ‚Üí</span></div>
                    <div class="status-row"><span>Speed:</span> <span id="statusSpeed" class="status-val">Cruise</span></div>
                    <div class="status-row"><span>Action:</span> <span id="statusAction" class="status-val">-</span></div>
                    <div class="status-row"><span>Timer:</span> <span id="statusTimer" class="status-val">-</span></div>
                    <div class="status-row" style="margin-top:5px; border-top:1px solid #ddd; padding-top:5px;">
                        <span>Last Code:</span> 
                        <span id="statusCode" class="status-val">-</span>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="section-title">üíæ Save/Load</h3>
                <div class="btn-group">
                    <button onclick="saveState()" style="background: #28a745;">üíæ Save State</button>
                    <button onclick="document.getElementById('fileInput').click()" style="background: #17a2b8;">üìÇ Load State</button>
                    <input type="file" id="fileInput" accept="application/json,.json" style="display: none;" onchange="loadState(event)">
                </div>
            </div>

        </div>
    </div>

    <!-- Floating Buttons -->
    <button class="floating-settings-btn" onclick="toggleSettings()" title="Settings">
        ‚öôÔ∏è
    </button>
    <button class="floating-help-btn" onclick="toggleHelp()" title="Color Code Reference">
        ‚ùì
    </button>

    <!-- Help Modal -->
    <div id="helpModal" class="modal-overlay" onclick="closeHelpModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span>üìò Color Code Reference</span>
                <button class="modal-close" onclick="closeHelp()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="help-menu">
                    <div class="help-header">üìò Color Code Reference</div>
                    <div class="help-content">
                        <div style="font-weight:bold; margin-bottom:5px; font-size:12px; color:#666;">SPEEDS</div>
                        <div class="help-item">
                            <span>Nitro Boost</span>
                            <div class="code-viz"><div class="code-block" style="background:blue;"></div><div class="code-block" style="background:green;"></div><div class="code-block" style="background:red;"></div></div>
                        </div>
                        <div class="help-item">
                            <span>Turbo</span>
                            <div class="code-viz"><div class="code-block" style="background:blue;"></div><div class="code-block" style="background:green;"></div><div class="code-block" style="background:blue;"></div></div>
                        </div>
                        <div class="help-item">
                            <span>Fast</span>
                            <div class="code-viz"><div class="code-block" style="background:blue;"></div><div class="code-block" style="background:black;"></div><div class="code-block" style="background:blue;"></div></div>
                        </div>
                        <div class="help-item">
                            <span>Cruise</span>
                            <div class="code-viz"><div class="code-block" style="background:green;"></div><div class="code-block" style="background:black;"></div><div class="code-block" style="background:green;"></div></div>
                        </div>
                        <div class="help-item">
                            <span>Slow</span>
                            <div class="code-viz"><div class="code-block" style="background:red;"></div><div class="code-block" style="background:black;"></div><div class="code-block" style="background:red;"></div></div>
                        </div>
                        <div class="help-item">
                            <span>Short Super Slow</span>
                            <div class="code-viz"><div class="code-block" style="background:red;"></div><div class="code-block" style="background:green;"></div><div class="code-block" style="background:blue;"></div></div>
                        </div>

                        <div style="font-weight:bold; margin:10px 0 5px; font-size:12px; color:#666;">AT INTERSECTIONS</div>
                        <div class="help-item">
                            <span>Left</span>
                            <div class="code-viz"><div class="code-block" style="background:green;"></div><div class="code-block" style="background:black;"></div><div class="code-block" style="background:red;"></div></div>
                        </div>
                        <div class="help-item">
                            <span>Straight</span>
                            <div class="code-viz"><div class="code-block" style="background:blue;"></div><div class="code-block" style="background:black;"></div><div class="code-block" style="background:red;"></div></div>
                        </div>
                        <div class="help-item">
                            <span>Right</span>
                            <div class="code-viz"><div class="code-block" style="background:blue;"></div><div class="code-block" style="background:red;"></div><div class="code-block" style="background:green;"></div></div>
                        </div>

                        <div style="font-weight:bold; margin:10px 0 5px; font-size:12px; color:#666;">LINE SWITCH</div>
                        <div class="help-item">
                            <span>Left</span>
                            <div class="code-viz"><div class="code-block" style="background:green;"></div><div class="code-block" style="background:red;"></div><div class="code-block" style="background:green;"></div></div>
                        </div>
                        <div class="help-item">
                            <span>Straight</span>
                            <div class="code-viz"><div class="code-block" style="background:green;"></div><div class="code-block" style="background:blue;"></div><div class="code-block" style="background:green;"></div></div>
                        </div>
                        <div class="help-item">
                            <span>Right</span>
                            <div class="code-viz"><div class="code-block" style="background:red;"></div><div class="code-block" style="background:green;"></div><div class="code-block" style="background:red;"></div></div>
                        </div>

                        <div style="font-weight:bold; margin:10px 0 5px; font-size:12px; color:#666;">SPECIAL MOVES</div>
                        <div class="help-item">
                            <span>U-Turn (line end)</span>
                            <div class="code-viz"><div class="code-block" style="background:blue;"></div><div class="code-block" style="background:red;"></div></div>
                        </div>

                        <div style="font-weight:bold; margin:10px 0 5px; font-size:12px; color:#666;">TIMER</div>
                        <div class="help-item">
                            <span>Timer Stop (X seconds)</span>
                            <div class="code-viz"><div class="code-block" style="background:red;"></div><div class="code-block" style="background:black;"></div><div class="code-block" style="background:blue;"></div><div class="code-block" style="background:green;"></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay" onclick="closeSettingsModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span>‚öôÔ∏è Settings</span>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-top: 0; margin-bottom: 15px; color: #007bff;">üìê Grid Size</h3>
                    <div style="font-size: 14px;">
                        <div style="margin-bottom: 15px; padding: 12px; background: #f8f9fa; border-radius: 6px;">
                            <div>Current Size: <span id="gridSizeDisplay" style="font-weight: bold; color: #007bff;">20 √ó 20</span></div>
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Width:</label>
                            <input type="number" id="gridWidth" value="20" min="10" max="50" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Height:</label>
                            <input type="number" id="gridHeight" value="20" min="10" max="50" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                        </div>
                        <button onclick="resizeGrid()" style="width: 100%; padding: 10px; background: #17a2b8; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 14px;">
                            Apply Grid Size
                        </button>
                    </div>
                </div>

                <div style="border-top: 2px solid #eee; padding-top: 30px;">
                    <h3 style="margin-top: 0; margin-bottom: 15px; color: #007bff;">‚è±Ô∏è Timer Settings</h3>
                    <div style="font-size: 14px;">
                        <div style="margin-bottom: 12px;">
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Timer Duration (seconds):</label>
                            <input type="number" id="timerDuration" value="30" min="1" max="60" style="width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;">
                        </div>
                        <div style="padding: 12px; background: #fff3cd; border-radius: 6px; color: #856404;">
                            <div style="margin-bottom: 5px;"><strong>Color Code:</strong> Red-Black-Blue-Green</div>
                            <div><strong>Status:</strong> <span id="timerStatus">Not Active</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    /** * CONFIGURATION 
     */
    const CELL_SIZE = 30; 
    let GRID_W = 20;    
    let GRID_H = 20;

    // Visual colors
    const COLORS = {
        'white': '#ffffff',
        'black': '#000000',
        'red':   '#ff0000',
        'green': '#00cc00', 
        'blue':  '#0066ff'
    };

    /** * CODE DEFINITIONS
     * Key format: "Color1-Color2-Color3" OR "Color1-Color2"
     * Robot reads a 7-cell window at every cell: 3 before, current, 3 after
     * Speed & U-turn: Execute immediately when detected
     * Turn commands: Stored and executed at next intersection
     */
    const CODES = {
        // === SPEED CODES (from official Ozobot chart) ===
        'blue-green-red':    { name: 'Nitro Boost',      type: 'speed', val: 50 },
        'blue-green-blue':   { name: 'Turbo',            type: 'speed', val: 80 },
        'blue-black-blue':   { name: 'Fast',             type: 'speed', val: 150 },
        'green-black-green': { name: 'Cruise',           type: 'speed', val: 300 },
        'red-black-red':     { name: 'Slow',             type: 'speed', val: 500 },
        'red-green-blue':    { name: 'Short Super Slow', type: 'speed', val: 900 },

        // === INTERSECTION CODES ===
        'green-black-red':   { name: 'Left at Intersection',     type: 'turn', val: 'left' },
        'blue-black-red':    { name: 'Straight at Intersection', type: 'turn', val: 'straight' },
        'blue-red-green':    { name: 'Right at Intersection',    type: 'turn', val: 'right' },

        // === LINE SWITCH CODES ===
        'green-red-green':   { name: 'Line Switch Left',     type: 'turn', val: 'left' },
        'green-blue-green':  { name: 'Line Switch Straight', type: 'turn', val: 'straight' },
        'red-green-red':     { name: 'Line Switch Right',    type: 'turn', val: 'right' },

        // === SPECIAL MOVES ===
        'blue-red':          { name: 'U-Turn (line end)', type: 'move', val: 'u-turn' },
        
        // === TIMER ===
        'red-black-blue-green': { name: 'Timer Stop', type: 'timer', val: null }
    };

    /** * GLOBAL STATE 
     */
    const canvas = document.getElementById('simCanvas');
    const ctx = canvas.getContext('2d');
    
    // Grid: 2D array of color strings
    let grid = createEmptyGrid();
    
    let robot = {
        r: 0, c: 0,           // Position
        dir: 1,               // 0:N, 1:E, 2:S, 3:W
        speedDelay: 300,      // ms per step
        active: false,
        nextTurn: null,       // Stored intersection command
        timerActive: false,   // Whether timer is running
        timerEndTime: null    // When timer should stop robot
    };

    let drawColor = 'black';
    let isDrawing = false;
    let loopId = null;

    /** * INITIALIZATION 
     */
    function init() {
        resetRobotState();
        updateGridSizeDisplay();
        render();
    }

    function createEmptyGrid() {
        return Array(GRID_H).fill(null).map(() => Array(GRID_W).fill('white'));
    }

    function resetRobotState() {
        robot.r = GRID_H - 2;  // Bottom of grid (leaving 1 cell margin)
        robot.c = 1;           // Left side (leaving 1 cell margin)
        robot.dir = 1;         // Facing East (right)
        robot.speedDelay = 300;
        robot.nextTurn = null;
        robot.timerActive = false;
        robot.timerEndTime = null;
        updateUI("Idle", "Cruise", "-", "-");
        updateDirectionDisplay();
        updateTimerDisplay();
    }

    /** * DRAWING TOOLS 
     */
    function setColor(c) {
        drawColor = c;
        document.querySelectorAll('.swatch').forEach(el => el.classList.remove('selected'));
        if (event && event.target.classList) {
            event.target.classList.add('selected');
        }
        // Update status message for robot mode
        if (c === 'robot') {
            updateUI(null, null, null, "Click to place robot");
        }
    }

    function setRobotDirection(dir) {
        // dir: 0=North, 1=East, 2=South, 3=West
        robot.dir = dir;
        updateDirectionDisplay();
        
        // Pause the game when changing direction
        if (robot.active) {
            stopRobot();
            const btn = document.getElementById('playBtn');
            btn.textContent = "‚ñ∂ Start Robot";
            btn.className = "btn-play";
        }
        
        render();
    }

    function updateDirectionDisplay() {
        const dirNames = ['North ‚Üë', 'East ‚Üí', 'South ‚Üì', 'West ‚Üê'];
        document.getElementById('statusDir').innerText = dirNames[robot.dir];
    }

    function updateGridSizeDisplay() {
        document.getElementById('gridSizeDisplay').innerText = `${GRID_W} √ó ${GRID_H}`;
        document.getElementById('gridWidth').value = GRID_W;
        document.getElementById('gridHeight').value = GRID_H;
    }

    function updateTimerDisplay() {
        const statusEl = document.getElementById('timerStatus');
        const mainStatusEl = document.getElementById('statusTimer');
        
        if (robot.timerActive && robot.timerEndTime) {
            const remaining = Math.max(0, Math.ceil((robot.timerEndTime - Date.now()) / 1000));
            const displayText = `${remaining}s remaining`;
            
            // Update Timer Settings section
            statusEl.innerText = `Active (${remaining}s remaining)`;
            statusEl.style.color = '#856404';
            statusEl.style.fontWeight = 'bold';
            
            // Update main Status section
            mainStatusEl.innerText = displayText;
        } else {
            // Update Timer Settings section
            statusEl.innerText = 'Not Active';
            statusEl.style.color = '#856404';
            statusEl.style.fontWeight = 'normal';
            
            // Update main Status section
            mainStatusEl.innerText = '-';
        }
    }

    function resizeGrid() {
        const newWidth = parseInt(document.getElementById('gridWidth').value);
        const newHeight = parseInt(document.getElementById('gridHeight').value);
        
        // Validate input
        if (isNaN(newWidth) || isNaN(newHeight) || newWidth < 10 || newHeight < 10 || newWidth > 50 || newHeight > 50) {
            alert('Please enter valid grid dimensions (10-50)');
            return;
        }
        
        // Stop the robot if running
        if (robot.active) {
            stopRobot();
            const btn = document.getElementById('playBtn');
            btn.textContent = "‚ñ∂ Start Robot";
            btn.className = "btn-play";
        }
        
        // Update grid dimensions
        GRID_W = newWidth;
        GRID_H = newHeight;
        
        // Resize canvas
        canvas.width = GRID_W * CELL_SIZE;
        canvas.height = GRID_H * CELL_SIZE;
        
        // Create new empty grid
        grid = createEmptyGrid();
        
        // Reset robot to bottom left
        resetRobotState();
        
        // Update display
        updateGridSizeDisplay();
        
        // Re-render
        render();
        
        updateUI(null, null, null, `Grid resized to ${GRID_W} √ó ${GRID_H}`);
    }

    function clearGrid() {
        stopRobot();
        grid = createEmptyGrid();
        resetRobotState();
        render();
    }

    function saveState() {
        // Create state object with all current data
        const state = {
            version: "1.0",
            timestamp: new Date().toISOString(),
            gridSize: {
                width: GRID_W,
                height: GRID_H
            },
            grid: grid,
            robot: {
                r: robot.r,
                c: robot.c,
                dir: robot.dir,
                speedDelay: robot.speedDelay,
                active: robot.active,
                nextTurn: robot.nextTurn
            }
        };

        // Convert to JSON
        const json = JSON.stringify(state, null, 2);
        
        // Create download link
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ozobot-state-${Date.now()}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        updateUI(null, null, null, "State saved!");
    }

    function loadState(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const state = JSON.parse(e.target.result);
                
                // Validate state
                if (!state.grid || !state.robot || !state.gridSize) {
                    throw new Error("Invalid state file format");
                }
                
                // Stop robot if running
                if (robot.active) {
                    stopRobot();
                    const btn = document.getElementById('playBtn');
                    btn.textContent = "‚ñ∂ Start Robot";
                    btn.className = "btn-play";
                }
                
                // Restore grid size if different
                if (state.gridSize.width !== GRID_W || state.gridSize.height !== GRID_H) {
                    GRID_W = state.gridSize.width;
                    GRID_H = state.gridSize.height;
                    canvas.width = GRID_W * CELL_SIZE;
                    canvas.height = GRID_H * CELL_SIZE;
                    updateGridSizeDisplay();
                }
                
                // Restore grid
                grid = state.grid;
                
                // Restore robot state
                robot.r = state.robot.r;
                robot.c = state.robot.c;
                robot.dir = state.robot.dir;
                robot.speedDelay = 300; // Always reset to Cruise speed
                robot.active = false; // Never restore as active
                robot.nextTurn = state.robot.nextTurn || null;
                robot.timerActive = false; // Always reset timer
                robot.timerEndTime = null;
                
                // Update UI
                updateDirectionDisplay();
                updateTimerDisplay();
                updateUI("Loaded", "Cruise", robot.nextTurn ? "Next: " + robot.nextTurn : "-", "State loaded successfully!");
                
                // Render
                render();
                
            } catch (error) {
                alert("Error loading state file: " + error.message);
                console.error(error);
            }
        };
        reader.readAsText(file);
        
        // Reset file input so same file can be loaded again
        event.target.value = '';
    }

    function loadDemo() {
        clearGrid();
        
        // ====== SIMPLE DEMO TRACK ======
        // Simple rectangular loop with key color codes
        
        // Main rectangular track
        // Top line (row 5)
        for(let c=3; c<=16; c++) grid[5][c] = 'black';
        // Right line (col 16)
        for(let r=5; r<=14; r++) grid[r][16] = 'black';
        // Bottom line (row 14)
        for(let c=3; c<=16; c++) grid[14][c] = 'black';
        // Left line (col 3)
        for(let r=5; r<=14; r++) grid[r][3] = 'black';
        
        // Add some speed codes around the loop
        // Top: Turbo (Blue-Green-Blue)
        grid[5][7] = 'blue'; grid[5][8] = 'green'; grid[5][9] = 'blue';
        
        // Right: Slow (Red-Black-Red)
        grid[9][16] = 'red'; grid[10][16] = 'black'; grid[11][16] = 'red';
        
        // Bottom: Fast (Blue-Black-Blue)
        grid[14][12] = 'blue'; grid[14][11] = 'black'; grid[14][10] = 'blue';
        
        // Left: Cruise (Green-Black-Green) - back to normal
        grid[11][3] = 'green'; grid[10][3] = 'black'; grid[9][3] = 'green';
        
        // Set Robot Start Position at bottom left
        robot.r = GRID_H - 2; 
        robot.c = 1; 
        robot.dir = 1; // Facing East
        robot.speedDelay = 300;
        robot.nextTurn = null;

        render();
        updateUI("Ready", "Cruise", "-", "Demo Track Loaded!");
    }

    // Mouse Events
    canvas.addEventListener('mousedown', (e) => { 
        // Allow setting robot position even when active (it will pause)
        // But only allow drawing when not active
        if (drawColor === 'robot' || !robot.active) {
            isDrawing = true; 
            paint(e); 
        }
    });
    canvas.addEventListener('mousemove', (e) => { 
        // Only allow drawing path when not active and not in robot mode
        if (isDrawing && !robot.active && drawColor !== 'robot') {
            paint(e); 
        }
    });
    canvas.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mouseleave', () => isDrawing = false);

    function paint(e) {
        const rect = canvas.getBoundingClientRect();
        const c = Math.floor((e.clientX - rect.left) / CELL_SIZE);
        const r = Math.floor((e.clientY - rect.top) / CELL_SIZE);
        if (r >= 0 && r < GRID_H && c >= 0 && c < GRID_W) {
            if (drawColor === 'robot') {
                // Set robot position
                robot.r = r;
                robot.c = c;
                updateUI(null, null, null, "Robot moved!");
                
                // Pause the game when setting robot position
                if (robot.active) {
                    stopRobot();
                    const btn = document.getElementById('playBtn');
                    btn.textContent = "‚ñ∂ Start Robot";
                    btn.className = "btn-play";
                }
                
                // Switch back to black after placing robot
                drawColor = 'black';
                document.querySelectorAll('.swatch').forEach(el => el.classList.remove('selected'));
                document.querySelector('.swatch[style*="black"]').classList.add('selected');
            } else {
                // Normal drawing
                grid[r][c] = drawColor;
            }
            render();
        }
    }

    /** * SIMULATION LOGIC 
     */
    function togglePlay() {
        const btn = document.getElementById('playBtn');
        if (robot.active) {
            stopRobot();
            btn.textContent = "‚ñ∂ Resume Robot";
            btn.className = "btn-play";
        } else {
            startRobot();
            btn.textContent = "‚è∏ Pause Robot";
            btn.className = "btn-stop";
        }
    }

    function startRobot() {
        if(robot.active) return;
        robot.active = true;
        updateUI("Running", null, null, null);
        gameLoop();
    }

    function stopRobot() {
        robot.active = false;
        clearTimeout(loopId);
        updateUI("Paused");
    }

    function gameLoop() {
        if (!robot.active) return;
        
        step();
        render();
        
        // Update timer display if active
        if (robot.timerActive) {
            updateTimerDisplay();
        }
        
        // Dynamic speed based on codes
        loopId = setTimeout(gameLoop, robot.speedDelay);
    }

    function step() {
        const currColor = grid[robot.r][robot.c];

        // Timer Check
        if (robot.timerActive && robot.timerEndTime && Date.now() >= robot.timerEndTime) {
            stopRobot();
            const btn = document.getElementById('playBtn');
            btn.textContent = "‚ñ∂ Start Robot";
            btn.className = "btn-play";
            robot.timerActive = false;
            robot.timerEndTime = null;
            updateUI("TIMER STOPPED", "-", "-", "Timer expired");
            updateTimerDisplay();
            return;
        }

        // Lost Line Check
        if (currColor === 'white') {
            stopRobot();
            const btn = document.getElementById('playBtn');
            btn.textContent = "‚ñ∂ Start Robot";
            btn.className = "btn-play";
            updateUI("LOST LINE", "-", "-", "Stop");
            return;
        }

        // --- Code Detection at every cell ---
        // Read 7-cell window: 3 before, current, 3 after
        checkCodes();

        // --- Movement Logic ---
        const move = calculateMove();
        
        if (move) {
            robot.r = move.r;
            robot.c = move.c;
            if (robot.dir !== move.dir) {
                robot.dir = move.dir;
                updateDirectionDisplay();
            }
        } else {
            // Dead End
            stopRobot();
            const btn = document.getElementById('playBtn');
            btn.textContent = "‚ñ∂ Start Robot";
            btn.className = "btn-play";
            updateUI("Stopped", "-", "-", "End of Line");
        }
    }

    function checkCodes() {
        // Direction vectors: N, E, S, W
        const dr = [-1, 0, 1, 0];
        const dc = [0, 1, 0, -1];
        
        // Read 7-cell window: 3 behind, current, 3 ahead
        const sequence = [];
        
        // Read 3 cells behind (opposite of current direction)
        for (let i = 3; i >= 1; i--) {
            const r = robot.r - dr[robot.dir] * i;
            const c = robot.c - dc[robot.dir] * i;
            if (r >= 0 && r < GRID_H && c >= 0 && c < GRID_W) {
                sequence.push(grid[r][c]);
            }
        }
        
        // Current cell
        sequence.push(grid[robot.r][robot.c]);
        
        // Read 3 cells ahead
        for (let i = 1; i <= 3; i++) {
            const r = robot.r + dr[robot.dir] * i;
            const c = robot.c + dc[robot.dir] * i;
            if (r >= 0 && r < GRID_H && c >= 0 && c < GRID_W) {
                sequence.push(grid[r][c]);
            }
        }
        
        // Try to match code patterns
        if (sequence.length >= 3) {
            let match = null;
            
            // Try 4-cell patterns first (for Timer)
            if (!match && sequence.length >= 7) {
                // Try center 4 cells (index 1,2,3,4 or 2,3,4,5)
                let seq4 = sequence.slice(1, 5).join('-');
                match = CODES[seq4];
                if (!match) {
                    seq4 = sequence.slice(2, 6).join('-');
                    match = CODES[seq4];
                }
            }
            if (!match && sequence.length >= 6) {
                let seq4 = sequence.slice(0, 4).join('-');
                match = CODES[seq4];
                if (!match) {
                    seq4 = sequence.slice(3, 7).join('-');
                    match = CODES[seq4];
                }
            }
            if (!match && sequence.length >= 5) {
                let seq4 = sequence.slice(1, 5).join('-');
                match = CODES[seq4];
            }
            if (!match && sequence.length >= 4) {
                let seq4 = sequence.slice(0, 4).join('-');
                match = CODES[seq4];
            }
            
            // Try 3-cell patterns in various positions within the 7-cell window
            if (!match && sequence.length >= 7) {
                // Try center 3 cells (index 2,3,4)
                let seq3 = sequence.slice(2, 5).join('-');
                match = CODES[seq3];
            }
            
            // Try other 3-cell windows
            if (!match && sequence.length >= 5) {
                let seq3 = sequence.slice(1, 4).join('-');
                match = CODES[seq3];
            }
            if (!match && sequence.length >= 4) {
                let seq3 = sequence.slice(0, 3).join('-');
                match = CODES[seq3];
            }
            if (!match && sequence.length >= 6) {
                let seq3 = sequence.slice(3, 6).join('-');
                match = CODES[seq3];
            }
            if (!match && sequence.length >= 3) {
                let seq3 = sequence.slice(sequence.length - 3).join('-');
                match = CODES[seq3];
            }
            
            // Try 2-cell patterns (for U-turn line end)
            // Special case: U-turn should execute when robot is on RED cell
            if (!match && sequence.length >= 2 && grid[robot.r][robot.c] === 'red') {
                // Check if the previous cell (1 behind) was blue
                const prevR = robot.r - dr[robot.dir] * 1;
                const prevC = robot.c - dc[robot.dir] * 1;
                if (prevR >= 0 && prevR < GRID_H && prevC >= 0 && prevC < GRID_W) {
                    if (grid[prevR][prevC] === 'blue') {
                        // We have Blue-Red pattern and robot is on Red
                        match = CODES['blue-red'];
                    }
                }
            }

            if (match) {
                // Display the detected code
                displayCode(match.name);
                
                // Execute actions based on type
                if (match.type === 'speed') {
                    // Speed codes execute immediately
                    robot.speedDelay = match.val;
                    document.getElementById('statusSpeed').innerText = match.name;
                } 
                else if (match.type === 'turn') {
                    // Turn codes are stored for next intersection
                    robot.nextTurn = match.val;
                    document.getElementById('statusAction').innerText = "Next: " + match.name;
                }
                else if (match.type === 'move' && match.name === 'U-Turn (line end)') {
                    // U-turn executes immediately on the red cell
                    robot.dir = (robot.dir + 2) % 4;
                    updateDirectionDisplay();
                }
                else if (match.type === 'timer') {
                    // Timer starts immediately
                    const duration = parseInt(document.getElementById('timerDuration').value) || 30;
                    robot.timerActive = true;
                    robot.timerEndTime = Date.now() + (duration * 1000);
                    updateTimerDisplay();
                    document.getElementById('statusAction').innerText = `Timer: ${duration}s`;
                }
            }
        }
    }


    function calculateMove() {
        const dr = [-1, 0, 1, 0]; // N, E, S, W
        const dc = [0, 1, 0, -1];
        
        // Find valid neighbors
        let validMoves = [];
        for (let i = 0; i < 4; i++) {
            // No 180 flips unless dead end logic forces it later
            if (i === (robot.dir + 2) % 4) continue;
            
            const nr = robot.r + dr[i];
            const nc = robot.c + dc[i];
            
            if (nr >= 0 && nr < GRID_H && nc >= 0 && nc < GRID_W) {
                if (grid[nr][nc] !== 'white') {
                    validMoves.push({ r: nr, c: nc, dir: i });
                }
            }
        }

        if (validMoves.length === 0) return null; // Dead end

        // Intersection Handling
        if (validMoves.length > 1) {
            // Check for Command
            if (robot.nextTurn) {
                let targetDir = -1;
                // Relative to current robot.dir
                if (robot.nextTurn === 'left') targetDir = (robot.dir + 3) % 4;
                else if (robot.nextTurn === 'right') targetDir = (robot.dir + 1) % 4;
                else if (robot.nextTurn === 'straight') targetDir = robot.dir;
                
                let chosen = validMoves.find(m => m.dir === targetDir);
                if (chosen) {
                    robot.nextTurn = null; // Consumed
                    document.getElementById('statusAction').innerText = "-";
                    return chosen;
                }
            }
            // Default: Random choice at intersections
            const randomIndex = Math.floor(Math.random() * validMoves.length);
            return validMoves[randomIndex];
        }

        // Single Path
        return validMoves[0];
    }

    /** * UI UPDATES 
     */
    function displayCode(name) {
        const el = document.getElementById('statusCode');
        el.innerText = name;
        el.classList.remove('code-flash');
        void el.offsetWidth; // Trigger reflow
        el.classList.add('code-flash');
    }

    function updateUI(state, speed, action, code) {
        if(state) document.getElementById('statusState').innerText = state;
        if(speed) document.getElementById('statusSpeed').innerText = speed;
        if(action) document.getElementById('statusAction').innerText = action;
        if(code) document.getElementById('statusCode').innerText = code;
    }

    function toggleHelp() {
        const modal = document.getElementById('helpModal');
        modal.classList.add('show');
    }

    function closeHelp() {
        const modal = document.getElementById('helpModal');
        modal.classList.remove('show');
    }

    function closeHelpModal(event) {
        // Close when clicking on the overlay (not the modal content)
        if (event.target === event.currentTarget) {
            closeHelp();
        }
    }

    function toggleSettings() {
        const modal = document.getElementById('settingsModal');
        modal.classList.add('show');
    }

    function closeSettings() {
        const modal = document.getElementById('settingsModal');
        modal.classList.remove('show');
    }

    function closeSettingsModal(event) {
        // Close when clicking on the overlay (not the modal content)
        if (event.target === event.currentTarget) {
            closeSettings();
        }
    }

    /** * RENDER 
     */
    function render() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw Grid
        for (let r = 0; r < GRID_H; r++) {
            for (let c = 0; c < GRID_W; c++) {
                const color = grid[r][c];
                if (color !== 'white') {
                    ctx.fillStyle = COLORS[color] || '#ccc';
                    ctx.fillRect(c * CELL_SIZE, r * CELL_SIZE, CELL_SIZE, CELL_SIZE);
                }
            }
        }

        // Draw Grid Lines
        ctx.strokeStyle = '#e0e0e0';
        ctx.lineWidth = 0.5;
        for (let i = 0; i <= GRID_W; i++) {
            ctx.beginPath();
            ctx.moveTo(i * CELL_SIZE, 0);
            ctx.lineTo(i * CELL_SIZE, GRID_H * CELL_SIZE);
            ctx.stroke();
        }
        for (let i = 0; i <= GRID_H; i++) {
            ctx.beginPath();
            ctx.moveTo(0, i * CELL_SIZE);
            ctx.lineTo(GRID_W * CELL_SIZE, i * CELL_SIZE);
            ctx.stroke();
        }

        // Draw Robot - Circle with Arrow showing direction
        const cx = robot.c * CELL_SIZE + CELL_SIZE / 2;
        const cy = robot.r * CELL_SIZE + CELL_SIZE / 2;
        const radius = CELL_SIZE * 0.35;

        // Robot outline (white border for visibility)
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, Math.PI * 2);
        ctx.stroke();

        // Robot body - dark circle
        ctx.fillStyle = '#2c3e50';
        ctx.beginPath();
        ctx.arc(cx, cy, radius, 0, Math.PI * 2);
        ctx.fill();

        // Direction arrow - clear and prominent
        ctx.save();
        ctx.translate(cx, cy);
        // Subtract 90¬∞ to align arrow with movement direction
        ctx.rotate((robot.dir - 1) * Math.PI / 2);
        
        // Arrow shape
        const arrowSize = radius * 0.7;
        ctx.fillStyle = '#00ff00';
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 1.5;
        
        ctx.beginPath();
        ctx.moveTo(arrowSize, 0);  // Arrow tip
        ctx.lineTo(-arrowSize * 0.5, -arrowSize * 0.6);  // Top wing
        ctx.lineTo(-arrowSize * 0.3, 0);  // Notch
        ctx.lineTo(-arrowSize * 0.5, arrowSize * 0.6);  // Bottom wing
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
        
        ctx.restore();
    }

    // Initialize on load
    init();

</script>
</body>
</html>